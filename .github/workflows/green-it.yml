name: Green IT check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

jobs:
  greenit:
    name: Green IT impact
    runs-on: ubuntu-latest

    steps:
      - name: Get Vercel preview URL from PR comment
        id: vercel
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const vercelComment = comments.data.find(c =>
              c.user?.login === 'vercel[bot]' && c.body?.includes('Visit Preview')
            );

            if (vercelComment) {
              const match = vercelComment.body.match(/\[Visit Preview\]\((.*?)\)/);
              if (match) {
                core.setOutput('preview-url', match[1]);
                console.log("âœ… URL Preview Vercel trouvÃ©e :", match[1]);
              } else {
                core.setFailed("âŒ Aucune URL 'Visit Preview' trouvÃ©e.");
              }
            } else {
              core.setFailed("âŒ Aucun commentaire Vercel trouvÃ©.");
            }

      - name: Call WebsiteCarbon API
        id: carbon
        run: |
          URL="${{ steps.vercel.outputs.preview-url }}"
          echo "ğŸ” Test de l'URL : $URL"

          if [ -z "$URL" ]; then
            echo "âŒ L'URL Vercel est vide. Abandon."
            exit 1
          fi

          RESPONSE=$(curl -s -H "x-vercel-protection-bypass: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}" \
            "https://api.websitecarbon.com/site?url=$URL")

          echo "ğŸ“„ RÃ©ponse brute de WebsiteCarbon :"
          echo "$RESPONSE"

          echo "$RESPONSE" > carbon.json

      - name: Comment (or update) PR with Green IT report
        uses: actions/github-script@v7
        env:
          PREVIEW_URL: ${{ steps.vercel.outputs.preview-url }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const vercelUrl = process.env.PREVIEW_URL;

            const reportRaw = fs.readFileSync('carbon.json', 'utf8');
            console.log("ğŸ“„ Contenu de carbon.json :", reportRaw);

            let report;
            try {
              report = JSON.parse(reportRaw);
            } catch (e) {
              core.setFailed('âŒ Le JSON renvoyÃ© nâ€™est pas valide. Peut-Ãªtre une redirection vers une page de login ?');
              return;
            }

            const stats = report?.statistics;
            const co2Grid = stats?.co2?.grid?.grams;
            const co2Renew = stats?.co2?.renewable?.grams;
            const litresGrid = stats?.co2?.grid?.litres;
            const litresRenew = stats?.co2?.renewable?.litres;
            const bytes = report?.bytes;
            const adjustedBytes = stats?.adjustedBytes;
            const energy = stats?.energy;
            const cleaner = report?.cleanerThan;
            const rating = report?.rating;
            const green = report?.green;

            if (
              typeof co2Grid !== 'number' || typeof co2Renew !== 'number' ||
              typeof cleaner !== 'number' || typeof bytes !== 'number'
            ) {
              core.setFailed('âŒ Le rapport WebsiteCarbon ne contient pas toutes les donnÃ©es attendues.');
              return;
            }

            const co2Emoji = co2Grid < 0.5 ? 'ğŸŸ¢' : (co2Grid < 1 ? 'ğŸŸ ' : 'ğŸ”´');
            const sizeEmoji = adjustedBytes < 1_000_000 ? 'ğŸŸ¢' : (adjustedBytes < 2_500_000 ? 'ğŸŸ ' : 'ğŸ”´');
            const energyEmoji = energy < 0.001 ? 'ğŸŸ¢' : (energy < 0.002 ? 'ğŸŸ ' : 'ğŸ”´');
            const cleanerEmoji = cleaner > 0.75 ? 'ğŸŸ¢' : (cleaner > 0.4 ? 'ğŸŸ ' : 'ğŸ”´');
            const greenEmoji = green === 'true' ? 'ğŸŸ¢' : (green === 'false' ? 'ğŸ”´' : 'â“');

            const body = [
              '<!-- greenit-report -->',
              '## ğŸŒ¿ Rapport Green IT (AutomatisÃ©)',
              '',
              `ğŸ”— **URL analysÃ©e** : [${vercelUrl}](${vercelUrl})`,
              '',
              `### Classement : **${rating ?? 'Non disponible'} ${cleanerEmoji}**`,
              `_Plus propre que : **${(cleaner * 100).toFixed(1)}%** des sites testÃ©s_`,
              '',
              `### ğŸ’¨ Ã‰missions estimÃ©es`,
              `- RÃ©seau classique : **${co2Grid.toFixed(2)}g COâ‚‚** ${co2Emoji} (~${litresGrid.toFixed(2)} litres d'air)`,
              `- Ã‰nergies renouvelables : **${co2Renew.toFixed(2)}g COâ‚‚** (~${litresRenew.toFixed(2)} litres d'air)`,
              '',
              `### ğŸ“Š DonnÃ©es techniques`,
              `- Taille brute de la page : **${(bytes / 1024).toFixed(1)} Ko**`,
              `- Taille ajustÃ©e : **${(adjustedBytes / 1024).toFixed(1)} Ko** ${sizeEmoji}`,
              `- Ã‰nergie estimÃ©e : **${(energy * 1000).toFixed(2)} Wh** ${energyEmoji}`,
              '',
              `### â™»ï¸ Autres indicateurs`,
              `- HÃ©bergeur vert : **${green === 'true' ? 'Oui' : (green === 'false' ? 'Non' : 'Inconnu')}** ${greenEmoji}`,
              '',
              '_DonnÃ©es fournies par [WebsiteCarbon.com](https://www.websitecarbon.com)_'
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 100
            });

            const existing = comments.find(c =>
              c.user?.type === 'Bot' &&
              c.body?.includes('<!-- greenit-report -->')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
              core.info('ğŸ” Commentaire Green IT mis Ã  jour');
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
              core.info('ğŸ†• Nouveau commentaire Green IT crÃ©Ã©');
            }

            const allowedRatings = ['A', 'B'];
            if (!rating || !allowedRatings.includes(rating)) {
              core.setFailed(`ğŸš¨ Score WebsiteCarbon trop faible ou absent : ${rating ?? 'non disponible'}. Minimum requis : B.`);
            }
